/*****************************************************************
**                   大连理工大学 创新创业学院
**                       物联网应用工坊
**---------------------------------------------------------------
** 项目名称：   WTZP1.0-BlueBerry
** 日    期：   2018-07-09
** 作    者：   王世许
**---------------------------------------------------------------
** 文 件 名：   LUX.c
** 文件说明：   光照强度测量
*****************************************************************/
/*---------------------INCLUDES----------------------*/
#include "LUX.h"

/*---------------------VARIABLES---------------------*/
uint8    BUF_0[8];                       //接收数据缓存区      	
uint16   dis_data_0;                     //变量

/*---------------------FUNCTIONS---------------------*/


/***********************************************************************
** 函 数 名： Delay5us()
** 函数说明： 延时5微妙
**---------------------------------------------------------------------
** 输入参数： 无
** 返回参数： 无
***********************************************************************/
void Delay5us()
{
  uint8 n = 120;
  
  while (n--);
}

/***********************************************************************
** 函 数 名： delay_ms
** 函数说明： 延时k毫秒
**---------------------------------------------------------------------
** 输入参数： k
** 返回参数： 无
***********************************************************************/
void delay_ms(uint16 k)	
{						
  uint16 i,j;				
  for(i=0;i<k;i++)
  {			
    for(j=0;j<24000;j++)			
    {
      ;
    }
  }						
}					

/***********************************************************************
** 函 数 名： LUX_Start()
** 函数说明： 起始信号
**---------------------------------------------------------------------
** 输入参数： 无
** 返回参数： 无
***********************************************************************/
void LUX_Start()
{
	LUX_SDA=1;
	
	LUX_SCL=1;
	Delay5us();//建立时间是SDA保持时间>4.7us
	LUX_SDA=0;
	Delay5us();//保持时间是>4us
	LUX_SCL=0;			
}

/***********************************************************************
** 函 数 名： LUX_Stop()
** 函数说明： 终止信号
**---------------------------------------------------------------------
** 输入参数： 无
** 返回参数： 无
***********************************************************************/

void LUX_Stop()
{
	LUX_SDA=0;
	LUX_SCL=1;
	Delay5us();
	LUX_SDA=1;
	Delay5us();//建立时间大于4.7us
	LUX_SCL=0;
	Delay5us();		
}

/***********************************************************************
** 函 数 名： LUX_SendACK(uint8 ack)
** 函数说明： 发送应答信号
**---------------------------------------------------------------------
** 输入参数： ack - 应答信号(0:ACK 1:NAK)
** 返回参数： 无
***********************************************************************/

void LUX_SendACK(uint8 ack)
{
  if (ack&0x01)	LUX_SDA=1;		 //写应答信号
  else	LUX_SDA=0;
  
  LUX_SCL=1;                    //拉高时钟线
  Delay5us();                 //延时
  LUX_SCL=0;                    //拉低时钟线
  LUX_SDA=1;
  Delay5us();                 //延时
}

/***********************************************************************
** 函 数 名： LUX_RecvACK()
** 函数说明： 接收应答信号
**---------------------------------------------------------------------
** 输入参数： 无
** 返回参数： 返回应答信号
***********************************************************************/

uint8 LUX_RecvACK()
{
  uint8 CY = 0x00;
  LUX_SDA=1;
	
  LUX_SCL=1;              //拉高时钟线
  Delay5us();                 //延时
  CY |= LUX_SDA;    //读应答信号
  Delay5us();                 //延时
  LUX_SCL=0;              //拉低时钟线
  return CY;
}

/***********************************************************************
** 函 数 名： LUX_SendByte(uint8 dat)
** 函数说明： 发送单个字节数据
**---------------------------------------------------------------------
** 输入参数： 发送的数据
** 返回参数： 无
***********************************************************************/

void LUX_SendByte(uint8 dat)
{
  uint8 i;
  
  for (i=0; i<8; i++)         			//8位计数器
  {
    if (dat&0x80)	LUX_SDA=1;	  //由最高位到最低位
    else	LUX_SDA=0;              //送数据口
    
    Delay5us();             			//延时
    LUX_SCL=1;                		//拉高时钟线
    Delay5us();             			//延时
    LUX_SCL=0;                		//拉低时钟线
    Delay5us();             			//延时
    dat <<= 1;              			//移出数据的最高位
  }
  
  LUX_RecvACK();
}

/***********************************************************************
** 函 数 名： LUX_ReadByte() 
** 函数说明： 读单个字节数据
**---------------------------------------------------------------------
** 输入参数： 无
** 返回参数： 读到的数据
***********************************************************************/

uint8 LUX_ReadByte()  //读一个8位数据，从高位读到低位
{
	uint8 a=0,dat=0;
	LUX_SDA=1;
	for(a=0;a<8;a++)
	{
		LUX_SCL=1;
		Delay5us();
		dat|=LUX_SDA;
		LUX_SCL=0;
		Delay5us();	
		dat<<=1;
	}
	return dat;
}

/***********************************************************************
** 函 数 名： LUX_Single_Write(uint8 dat)
** 函数说明： 写BH1750
**---------------------------------------------------------------------
** 输入参数： 写入的指令
** 参数说明:  0x46 - 寄存器地址
** 返回参数： 无
***********************************************************************/
void LUX_Single_Write(uint8 dat)
{
  LUX_Start();          //起始信号
  LUX_SendByte(0x46);   //发送设备地址
  LUX_SendByte(dat);    //发送数据
  LUX_Stop();           //发送停止信号
}

/***********************************************************************
** 函 数 名： LUX_Multiple_read()
** 函数说明： 连续读取6个地址数据
**---------------------------------------------------------------------
** 输入参数： 无
** 返回参数： 无
***********************************************************************/
void LUX_Multiple_read()
{   
  uint8 i;	
  LUX_Start();                  //起始信号
  LUX_SendByte(0x46+1);         //发送设备地址+读信号
  
  for (i=0; i<3; i++)           //连续读取6个地址数据，存储中BUF
  {
    BUF_0[i] = LUX_ReadByte();  //BUF[0]存储0x32地址中的数据
    if (i == 3)
    {
      LUX_SendACK(1);           //最后一个数据需要回NOACK
    }
    else
    {		
      LUX_SendACK(0);           //回应ACK
    }
  }
  
  LUX_Stop();                   //停止信号
  delay_ms(5);
}

/***********************************************************************
** 函 数 名： LUX_Init()
** 函数说明： 初始化光照传感器
**---------------------------------------------------------------------
** 输入参数： 无
** 返回参数： 无
***********************************************************************/

void LUX_Init()
{
  LUX_Single_Write(0x01); 
}

/***********************************************************************
** 函 数 名： Get_Lux()
** 函数说明： 光照读取函数
**---------------------------------------------------------------------
** 输入参数： 无
** 返回参数： 光照强度（单位：lx)
***********************************************************************/

uint32 Get_Lux()
{  
  f32 temp;
  LUX_Single_Write(0x01);   // 通电
  LUX_Single_Write(0x10);

  delay_ms(200);            //延时180ms
  
  LUX_Multiple_read();      //连续读出数据，存储在BUF中
  
  LUX_Single_Write(0x00);   // 断电
  
  dis_data_0=BUF_0[0];
  dis_data_0=(dis_data_0<<8)+BUF_0[1]; //合成数据，即光照数据

  temp=(float)dis_data_0/1.2;
  return (uint32)(temp*1.4);
} 


