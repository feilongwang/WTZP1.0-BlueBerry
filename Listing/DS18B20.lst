C51 COMPILER V9.00   DS18B20                                                               07/13/2018 11:16:28 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN .\Output\DS18B20.obj
COMPILER INVOKED BY: E:\Program Files\keil5\C51\BIN\C51.EXE Modules\DS18B20.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEN
                    -D PRINT(.\Listing\DS18B20.lst) TABS(2) OBJECT(.\Output\DS18B20.obj)

line level    source

   1          /*****************************************************************
   2          **                   大连理工大学 创新创业学院
   3          **                       物联网应用工坊
   4          **---------------------------------------------------------------
   5          ** 项目名称：   WTZP1.0-BlueBerry
   6          ** 日    期：   2018-07-07
   7          ** 作    者：   温武军
   8          **---------------------------------------------------------------
   9          ** 文 件 名：   DS18B20.c
  10          ** 文件说明：   溶液温度测量
  11          *****************************************************************/
  12          
  13          /*---------------------INCLUDES----------------------*/
  14          #include "DS18B20.h"
  15          
  16          /*---------------------VARIABLES---------------------*/
  17          int16 LiquidT;
  18          uint8 a[2];
  19          
  20          /*---------------------FUNCTIONS---------------------*/
  21          /***********************************************************************
  22          ** 函 数 名： DS18B20rest()
  23          ** 函数说明： 复位DS18B20
  24          **---------------------------------------------------------------------
  25          ** 输入参数： 无
  26          ** 返回参数： uint8
  27          ***********************************************************************/
  28          unsigned char DS18B20rest()
  29          {
  30   1        //unsigned char a;用于复位检测
  31   1        DQ=1;
  32   1        delay1us(10);
  33   1        DQ=0;
  34   1        delay1us(800);
  35   1        DQ=1;
  36   1        delay1us(600);
  37   1        return 1;
  38   1      }
  39          /***********************************************************************
  40          ** 函 数 名： write_byte()
  41          ** 函数说明： 写一个字节
  42          **---------------------------------------------------------------------
  43          ** 输入参数： uint8
  44          ** 返回参数： 无
  45          ***********************************************************************/
  46          void write_byte(unsigned char dat)
  47          {
  48   1        unsigned char i;
  49   1        unsigned char temp;
  50   1        for(i=0;i<8;i++)
  51   1        {
  52   2          temp=dat&0x01;
  53   2          DQ=0;
  54   2          delay1us(15);
C51 COMPILER V9.00   DS18B20                                                               07/13/2018 11:16:28 PAGE 2   

  55   2          DQ=dat&0x01;
  56   2          delay1us(45);
  57   2          DQ=1;
  58   2          delay1us(10);
  59   2          dat=dat>>1;
  60   2        }
  61   1        //delayus(100);
  62   1      }
  63          /***********************************************************************
  64          ** 函 数 名： read_byte()
  65          ** 函数说明： 读一个字节
  66          **---------------------------------------------------------------------
  67          ** 输入参数： 无
  68          ** 返回参数： uint8
  69          ***********************************************************************/
  70          unsigned char read_byte()
  71          {
  72   1        unsigned char i;
  73   1        unsigned char val;
  74   1        for(i=0;i<8;i++)
  75   1        {
  76   2          val>>=1;
  77   2          DQ=0; 
  78   2          delay1us(2);
  79   2          DQ=1;
  80   2          delay1us(4);
  81   2          if(DQ)
  82   2          {
  83   3            val=val|=0x80;
  84   3          }
  85   2          delay1us(30);
  86   2        }
  87   1        return val;
  88   1      }
  89          /***********************************************************************
  90          ** 函 数 名： DS18B20Start()
  91          ** 函数说明： 启动DS18B20
  92          **---------------------------------------------------------------------
  93          ** 输入参数： 无
  94          ** 返回参数： uint8
  95          ***********************************************************************/
  96          unsigned char DS18B20Start()
  97          {
  98   1        unsigned char a;
  99   1        a=DS18B20rest();
 100   1        if(a)
 101   1        {
 102   2          write_byte(0xcc);
 103   2          write_byte(0x44);
 104   2          return 1;
 105   2        }
 106   1        else 
 107   1          return 0;
 108   1      }
 109          /***********************************************************************
 110          ** 函 数 名： DS18B20()
 111          ** 函数说明： 再次启动DS18B20，并获得温度数据
 112          **---------------------------------------------------------------------
 113          ** 输入参数： 无
 114          ** 返回参数： int16(已转换好的温度)
 115          ***********************************************************************/
 116          int DS18B20()
C51 COMPILER V9.00   DS18B20                                                               07/13/2018 11:16:28 PAGE 3   

 117          {
 118   1        //unsigned int TX,TZ;
 119   1        unsigned char b;
 120   1        float tt=0;
 121   1        b=DS18B20rest();
 122   1        if(b)
 123   1        {
 124   2          write_byte(0xcc);
 125   2          write_byte(0xbe);
 126   2          a[0]=read_byte();//低位
 127   2          a[1]=read_byte();//高位
 128   2          DQ=1;
 129   2        }
 130   1        LiquidT=a[1];
 131   1        LiquidT=LiquidT<<8;
 132   1        LiquidT=LiquidT|a[0];
 133   1        //TZ=(DS18B.a[0]>>4)|((DS18B.a[1]<<4)&0x3f);//温度整数部分
 134   1        //TX=DS18B.a[0]<<4;//温度小数部分
 135   1        tt=LiquidT*0.0625;
 136   1        LiquidT=tt*10+0.5;//获取小数部分，并四舍五入
 137   1        return LiquidT;
 138   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    281    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4       9
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
