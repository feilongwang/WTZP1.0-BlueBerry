C51 COMPILER V9.00   AM2301                                                                08/23/2018 20:19:23 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE AM2301
OBJECT MODULE PLACED IN .\Output\AM2301.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Modules\AM2301.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT
                    -(.\Listing\AM2301.lst) TABS(2) OBJECT(.\Output\AM2301.obj)

line level    source

   1          /*****************************************************************
   2          **                   大连理工大学 创新创业学院
   3          **                       物联网应用工坊
   4          **---------------------------------------------------------------
   5          ** 项目名称：   WTZP1.0-BlueBerry
   6          ** 日    期：   2018-07-30
   7          ** 作    者：   王飞龙
   8          **---------------------------------------------------------------
   9          ** 文 件 名：   AM2301.c
  10          ** 文件说明：   环境温湿度模块
  11          *****************************************************************/
  12          /*---------------------INCLUDES----------------------*/
  13          #include "AM2301.h"
  14          
  15          /*---------------------VARIABLES---------------------*/
  16          unsigned char RecData[5];
  17          unsigned char TempAnsFlag,TempErrorFlag; 
  18          
  19          /*---------------------FUNCTIONS---------------------*/
  20          /***********************************************************************
  21          ** 函 数 名： AM2301Start()
  22          ** 函数说明： 初始化AM2301
  23          **---------------------------------------------------------------------
  24          ** 输入参数： 无
  25          ** 返回参数： 无
  26          ***********************************************************************/
  27          void AM2301Start()
  28          {
  29   1        TEMP_SDA=0;
  30   1        delay_ms(6);  //延时6ms
  31   1        TEMP_SDA=1;
  32   1        Delay_N10us(3);//延时30us
  33   1        TEMP_SDA=1;
  34   1        TempAnsFlag=0;
  35   1        TempErrorFlag=0;
  36   1      }
  37          /***********************************************************************
  38          ** 函 数 名： AM2301SingleRec()
  39          ** 函数说明： 接收AM2301数据
  40          **---------------------------------------------------------------------
  41          ** 输入参数： 无
  42          ** 返回参数： unsigned char
  43          ***********************************************************************/
  44          unsigned char AM2301SingleRec()
  45          {
  46   1        unsigned char i,dat=0,cnt;
  47   1        for(i=0;i<8;i++)
  48   1        {
  49   2          cnt=0;
  50   2          while(!TEMP_SDA){if(++cnt>=200){break;}}
  51   2          Delay_N10us(4);//延时40us
  52   2          dat=TEMP_SDA;
  53   2          cnt=0;
  54   2          while(!TEMP_SDA){if(++cnt>=200){break;}}
C51 COMPILER V9.00   AM2301                                                                08/23/2018 20:19:23 PAGE 2   

  55   2          dat<<=1;
  56   2        }
  57   1        return dat;   
  58   1      }
  59          /***********************************************************************
  60          ** 函 数 名： DataCheck()
  61          ** 函数说明： 接收AM2301数据校验
  62          **---------------------------------------------------------------------
  63          ** 输入参数： 无
  64          ** 返回参数： unsigned char
  65          ***********************************************************************/
  66          unsigned char DataCheck()
  67          {
  68   1        if((RecData[0]+RecData[1]+RecData[2]+RecData[3])==RecData[4])
  69   1        {
  70   2          return 1;
  71   2        }
  72   1        return 0;
  73   1      }
  74          /***********************************************************************
  75          ** 函 数 名： H_T_Caculate()
  76          ** 函数说明： 数据湿度、温度计算
  77          **---------------------------------------------------------------------
  78          ** 输入参数： unsigned char a[]
  79          ** 返回参数： unsigned int
  80          ***********************************************************************/
  81          unsigned int H_T_Caculate(unsigned char a[])//湿度、温度计算
  82          {
  83   1        unsigned int result;
  84   1        result=a[0];
  85   1        result=result<<8;
  86   1        result|=a[1];
  87   1        return result;  
  88   1      } 
  89          /***********************************************************************
  90          ** 函 数 名： AM2301()
  91          ** 函数说明： 使用AM2301时调用此函数，获得温湿度，注：温度与湿度需外部定义
  92          **---------------------------------------------------------------------
  93          ** 输入参数： 无
  94          ** 返回参数： unsigned char
  95          ***********************************************************************/
  96          unsigned char AM2301()//使用AM2301时调用此函数
  97          {
  98   1        unsigned char i;
  99   1        unsigned char cnt;
 100   1        AM2301Start();
 101   1        if(TEMP_SDA==0)
 102   1        {
 103   2          TempAnsFlag=1;
 104   2          cnt=0;
 105   2          while(!TEMP_SDA)
 106   2          {
 107   3            if(++cnt>300)
 108   3            {
 109   4               TempErrorFlag=1;
 110   4               return 0;
 111   4            }
 112   3          }
 113   2          cnt=0;
 114   2          while(TEMP_SDA)
 115   2          {
 116   3            if(++cnt>300)
C51 COMPILER V9.00   AM2301                                                                08/23/2018 20:19:23 PAGE 3   

 117   3            {
 118   4               TempErrorFlag=1;
 119   4               return 0;
 120   4            } 
 121   3          }
 122   2          for(i=0;i<5;i++)
 123   2          {
 124   3            RecData[i]=AM2301SingleRec();
 125   3          }
 126   2        }
 127   1        else
 128   1        {
 129   2          TempAnsFlag=0;
 130   2          return 0;
 131   2        }
 132   1        if(TempAnsFlag)
 133   1        {
 134   2          if(DataCheck())
 135   2          {
 136   3            DateHumidity=H_T_Caculate(RecData);
 137   3            DateTemp=H_T_Caculate(RecData+2);
 138   3            return 1;
 139   3          }
 140   2        }
 141   1        return 0;       
 142   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    328    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      7       4
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
