C51 COMPILER V9.00   WIFI                                                                  07/20/2018 11:36:11 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE WIFI
OBJECT MODULE PLACED IN .\Output\Wifi.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Modules\Wifi.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.
                    -\Listing\Wifi.lst) TABS(2) OBJECT(.\Output\Wifi.obj)

line level    source

   1          /*****************************************************************
   2          **                   大连理工大学 创新创业学院
   3          **                       物联网应用工坊
   4          **---------------------------------------------------------------
   5          ** 项目名称：   WTZP1.0-BlueBerry
   6          ** 日    期：   2018-07-14
   7          ** 作    者：   温武军
   8          **---------------------------------------------------------------
   9          ** 文 件 名：   Wifi.c
  10          ** 文件说明：   wifi功能模块(与wifi模块通信有问题)
  11          *****************************************************************/
  12          /*---------------------INCLUDES----------------------*/
  13          #include "Wifi.h"
  14          
  15          /*---------------------VARIABLES---------------------*/
  16          char xdata Link[110]="{\"t\": 1,\"device\": \"BlueBerry\",\"key\":\"d9b8d549677e42d989f35401b6c0790f\",\"v
             -er\":\"v1.0\"}";
  17          char xdata Date[100]="{\"t\":3,\"datatype\":1,\"datas\":{\"Ph";
  18          char xdata DateMid[10]="\":19";
  19          char xdata DateBack[14]="},\"msgid\":1}";
  20          char xdata BeatQus[7]="$#AT#\r";
  21          char KeyName[7][9]={{"Ph"},{"LiquidT"},{"Humidity"},{"Lux"},{"Temp"},{"EC"},{"CO2"}};//传感器识别码
  22          char xdata Ack[64],*JSONp=Ack;
  23            
  24          
  25          
  26          /*---------------------FUNCTIONS---------------------*/
  27          /***********************************************************************
  28          ** 函 数 名： WifiRec()
  29          ** 函数说明： 接收来自WiFi模块的JSON
  30          **---------------------------------------------------------------------
  31          ** 输入参数： 无
  32          ** 返回参数： uint8
  33          ***********************************************************************/
  34          uint8 WifiRec()
  35          {
  36   1        int j=0;
  37   1        char k;
  38   1        k=UartRec2();
  39   1        {
  40   2          while(!k)
  41   2          {j++;if(j>300)return 0;}//等待无果返回0
  42   2          *JSONp=k;
  43   2        }while(JSONp++);
  44   1        return 1;//成功返回1
  45   1      }
  46          /***********************************************************************
  47          ** 函 数 名： JsonKeyRec()
  48          ** 函数说明： 获取JSON键值
  49          **---------------------------------------------------------------------
  50          ** 输入参数： 目标键名，键值储存地址
  51          ** 返回参数： uint16,键值的地址
  52          ***********************************************************************/
  53          uint16 WifiLinkAck(char *JsonKey)
C51 COMPILER V9.00   WIFI                                                                  07/20/2018 11:36:11 PAGE 2   

  54          {
  55   1        char *value;
  56   1        char *JsonKeyStart;//键名开始的地址
  57   1        char *JsonKeyEnd;//键名结束的地址
  58   1        char JsonKeyLength;//键名长度
  59   1        JsonKeyStart=strstr(JSONp,JsonKey);
  60   1        JsonKeyLength=strlen(JsonKey);
  61   1        JsonKeyEnd=JsonKeyStart+JsonKeyLength;
  62   1        if(JsonKeyStart != 0 && *(JsonKeyStart - 1) == '\"' && *(JsonKeyEnd) == '\"' && *(JsonKeyEnd + 1) == ':' 
             -&& *(JsonKeyEnd + 2) == '\"' )
  63   1        {
  64   2          value=JsonKeyEnd+2;
  65   2        }
  66   1        return value;
  67   1      }
  68          /***********************************************************************
  69          ** 函 数 名： WifiLink()
  70          ** 函数说明： 与云平台台建立链接
  71          **---------------------------------------------------------------------
  72          ** 输入参数： 无
  73          ** 返回参数： 无
  74          ***********************************************************************/
  75          void WifiLink()
  76          {
  77   1        UartSend2_str(Link);
  78   1      }
  79          /***********************************************************************
  80          ** 函 数 名： WifiBeat()
  81          ** 函数说明： 与云平台台建立心跳连接
  82          **---------------------------------------------------------------------
  83          ** 输入参数： 无
  84          ** 返回参数： 无
  85          ***********************************************************************/
  86          void WifiBeat()
  87          {
  88   1        UartSend2_str(BeatQus);
  89   1      }
  90          /***********************************************************************
  91          ** 函 数 名： JsonMakePak()
  92          ** 函数说明： 组包
  93          **---------------------------------------------------------------------
  94          ** 输入参数： int8 rank,int16 value
  95          ** 返回参数： uint16,键值的地址
  96          ***********************************************************************/
  97          uint16 JsonMakePak(int8 rank,int16 value)
  98          {
  99   1        #define DateKeyStart 30
 100   1        uint8 DateValueLen;
 101   1        switch(rank)
 102   1        {
 103   2          case 0:strcpy(Date+DateKeyStart,KeyName[0]);break;//使数据指针指向数据首地址
 104   2          case 1:strcpy(Date+DateKeyStart,KeyName[1]);break;
 105   2          case 2:strcpy(Date+DateKeyStart,KeyName[2]);break;
 106   2          case 3:strcpy(Date+DateKeyStart,KeyName[3]);break;
 107   2          case 4:strcpy(Date+DateKeyStart,KeyName[4]);break;
 108   2          case 5:strcpy(Date+DateKeyStart,KeyName[5]);break;
 109   2          case 6:strcpy(Date+DateKeyStart,KeyName[6]);break;
 110   2        }
 111   1        DateValueLen=sprintf(DateMid+2,"%d",value);
 112   1        strcat(Date,DateMid);
 113   1        strcat(Date,DateBack);
 114   1        return Date;
C51 COMPILER V9.00   WIFI                                                                  07/20/2018 11:36:11 PAGE 3   

 115   1      }
 116          /***********************************************************************
 117          ** 函 数 名： Wifidat()
 118          ** 函数说明： 发送数据
 119          **---------------------------------------------------------------------
 120          ** 输入参数： int8 rank,int16 DAT
 121          ** 返回参数： 无
 122          ***********************************************************************/
 123          void Wifidat(int8 rank1,int16 DAT)
 124          {
 125   1        JsonMakePak(rank1,DAT);
 126   1        UartSend2_str(Date);
 127   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    540    ----
   CONSTANT SIZE    =      3    ----
   XDATA SIZE       =    371      17
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
