C51 COMPILER V9.00   WIFI                                                                  08/23/2018 10:22:21 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE WIFI
OBJECT MODULE PLACED IN .\Output\Wifi.obj
COMPILER INVOKED BY: E:\Program Files\keil5\C51\BIN\C51.EXE Modules\Wifi.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEX
                    -TEND PRINT(.\Listing\Wifi.lst) TABS(2) OBJECT(.\Output\Wifi.obj)

line level    source

   1          /*****************************************************************
   2          **                   大连理工大学 创新创业学院
   3          **                       物联网应用工坊
   4          **---------------------------------------------------------------
   5          ** 项目名称：   WTZP1.0-BlueBerry
   6          ** 日    期：   2018-07-19
   7          ** 作    者：   温武军
   8          **---------------------------------------------------------------
   9          ** 文 件 名：   Wifi.c
  10          ** 文件说明：   wifi功能模块
  11          *****************************************************************/
  12          /*---------------------INCLUDES----------------------*/
  13          #include "Wifi.h"
  14          
  15          /*---------------------VARIABLES---------------------*/
  16          char xdata Link[110]="{\"t\": 1,\"device\": \"BlueBerry\",\"key\":\"d9b8d549677e42d989f35401b6c0790f\",\"v
             -er\":\"v1.0\"}";
  17          char xdata Date[300]="{\"t\":3,\"datatype\":1,\"datas\":{\"Ph";
  18          char xdata DateMid1[10]="\":0";
  19          char xdata DateMid2[10]=",\"";
  20          char xdata DateBack[14]="},\"msgid\":1}";
  21          char xdata BeatQus[7]="$#AT#\r";
  22          char KeyName[7][9]={{"Ph"},{"LiquidT"},{"Humidity"},{"Lux"},{"Temp"},{"EC"},{"CO2"}};//传感器识别码
  23          int8 KeyLen[7]={2,7,8,3,4,2,3};//识别码长度
  24          char xdata Ack[64];
  25          char xdata *JSONp=Ack;
  26          extern uint16 DateLiquidT;extern uint16 DateCO2;extern uint16 DatePh;extern uint16 DateHumidity;
  27          extern uint16 DateTemp;extern int16 DateEc;extern uint32 DateLux;
  28          
  29          /*---------------------FUNCTIONS---------------------*/
  30          /***********************************************************************
  31          ** 函 数 名： WifiRec()
  32          ** 函数说明： 接收来自WiFi模块的JSON
  33          **---------------------------------------------------------------------
  34          ** 输入参数： 无
  35          ** 返回参数： uint8
  36          ***********************************************************************/
  37          uint8 WifiRec()
  38          {
  39   1        int j=0;
  40   1        char k;
  41   1        k=UartRec2(Ack);
  42   1        {
  43   2          while(!k)
  44   2          {j++;if(j>300)return 0;}//等待无果返回0
  45   2          *JSONp=k;
  46   2        }while(JSONp++);
  47   1        return 1;//成功返回1
  48   1      }
  49          /***********************************************************************
  50          ** 函 数 名： JsonKeyRec()
  51          ** 函数说明： 获取JSON键值
  52          **---------------------------------------------------------------------
  53          ** 输入参数： 目标键名，键值储存地址
C51 COMPILER V9.00   WIFI                                                                  08/23/2018 10:22:21 PAGE 2   

  54          ** 返回参数： uint16,键值的地址
  55          ***********************************************************************/
  56          uint16 JsonKeyRec(char *JsonKey)
  57          {
  58   1        char *ValueAddr;
  59   1        char *JsonKeyStart;//键名开始的地址
  60   1        char *JsonKeyEnd;//键名结束的地址
  61   1        char JsonKeyLength;//键名长度
  62   1        JsonKeyStart=strstr(JSONp,JsonKey);
  63   1        JsonKeyLength=strlen(JsonKey);
  64   1        JsonKeyEnd=JsonKeyStart+JsonKeyLength;
  65   1        if(JsonKeyStart != 0 && *(JsonKeyStart - 1) == '\"' && *(JsonKeyEnd) == '\"' && *(JsonKeyEnd + 1) == ':')
  66   1        {
  67   2          ValueAddr=JsonKeyEnd+2;
  68   2        }
  69   1        return ValueAddr;
  70   1      }
  71          /***********************************************************************
  72          ** 函 数 名： WifiLink()
  73          ** 函数说明： 与云平台台建立链接
  74          **---------------------------------------------------------------------
  75          ** 输入参数： 无
  76          ** 返回参数： 无
  77          ***********************************************************************/
  78          void WifiLink()
  79          {
  80   1        UartSend2_str(Link);
  81   1      }
  82          /***********************************************************************
  83          ** 函 数 名： WifiBeat()
  84          ** 函数说明： 与云平台台建立心跳连接
  85          **---------------------------------------------------------------------
  86          ** 输入参数： 无
  87          ** 返回参数： 无
  88          ***********************************************************************/
  89          void WifiBeat()
  90          {
  91   1        UartSend2_str(BeatQus);
  92   1      }
  93          /***********************************************************************
  94          ** 函 数 名： JsonMakePak1()
  95          ** 函数说明： 组包(只打包一个数据)
  96          **---------------------------------------------------------------------
  97          ** 输入参数： int8 rank,uint32 value
  98          ** 返回参数： uint16,键值的地址
  99          ***********************************************************************/
 100          /*uint16 JsonMakePak1(int8 rank,uint32 value)
 101          {
 102            char DateKeyStart=30;
 103            uint8 DateValueLen;
 104            switch(rank)
 105            {
 106              case 0:strcpy(Date+DateKeyStart,KeyName[0]);break;//使数据指针指向数据首地址
 107              case 1:strcpy(Date+DateKeyStart,KeyName[1]);break;
 108              case 2:strcpy(Date+DateKeyStart,KeyName[2]);break;
 109              case 3:strcpy(Date+DateKeyStart,KeyName[3]);break;
 110              case 4:strcpy(Date+DateKeyStart,KeyName[4]);break;
 111              case 5:strcpy(Date+DateKeyStart,KeyName[5]);break;
 112              case 6:strcpy(Date+DateKeyStart,KeyName[6]);break;
 113            }
 114            DateValueLen=sprintf(DateMid1+2,"%d",value);
 115            strcat(Date,DateMid1);
C51 COMPILER V9.00   WIFI                                                                  08/23/2018 10:22:21 PAGE 3   

 116            strcat(Date,DateBack);
 117            return Date;
 118          }/*
 119          /***********************************************************************
 120          ** 函 数 名： JsonMakePak2()
 121          ** 函数说明： 组包(打包一组传感器数据)
 122          **---------------------------------------------------------------------
 123          ** 输入参数： 无
 124          ** 返回参数： uint16,键值的地址
 125          ***********************************************************************/
 126          uint16 JsonMakePak2()
 127          {
 128   1        uint8 DateValueLen=0;
 129   1        uint16 value1=0;
 130   1        int8 i=0;
 131   1        char xdata *DateKeyStart;
 132   1        DateKeyStart=Date+30;//使数据指针指向数据首地址
 133   1        for(i=0;i<7;i++)
 134   1        {
 135   2          strcpy(DateKeyStart,KeyName[i]);
 136   2          DateKeyStart=DateKeyStart+KeyLen[i];
 137   2          *DateKeyStart=0;
 138   2          switch(i)
 139   2          {
 140   3            case 0:value1=DatePh;break;//获得数据
 141   3            case 1:value1=DateLiquidT;break;
 142   3            case 2:value1=DateHumidity;break;
 143   3            case 3:value1=DateLux;break;
 144   3            case 4:value1=DateTemp;break;
 145   3            case 5:value1=DateEc;break;
 146   3            case 6:value1=DateCO2;break;
 147   3          }
 148   2          DateValueLen=sprintf(DateMid1+2,"%d",value1);
 149   2          strcat(Date,DateMid1);
 150   2          DateKeyStart=DateKeyStart+DateValueLen+2;
 151   2          *DateKeyStart=0;
 152   2          if(i!=6)
 153   2          {
 154   3            strcat(Date,DateMid2);
 155   3            DateKeyStart=DateKeyStart+2;
 156   3          }
 157   2        }
 158   1        strcat(Date,DateBack);
 159   1        return Date;
 160   1      }
 161          /***********************************************************************
 162          ** 函 数 名： Wifidat()
 163          ** 函数说明： 发送一个传感器数据
 164          **---------------------------------------------------------------------
 165          ** 输入参数： int8 rank,int16 DAT
 166          ** 返回参数： 无
 167          ***********************************************************************/
 168          /*void Wifidat(int8 rank1,uint32 DAT)
 169          {
 170            JsonMakePak1(rank1,DAT);
 171            UartSend2_str(Date);
 172          }*/
 173          /***********************************************************************
 174          ** 函 数 名： WifidatPackt()
 175          ** 函数说明： 发送一组传感器数据
 176          **---------------------------------------------------------------------
 177          ** 输入参数： 无
C51 COMPILER V9.00   WIFI                                                                  08/23/2018 10:22:21 PAGE 4   

 178          ** 返回参数： 无
 179          ***********************************************************************/
 180          void WifidatPack()
 181          {
 182   1        JsonMakePak2();
 183   1        UartSend2_str(Date);
 184   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    692    ----
   CONSTANT SIZE    =      3    ----
   XDATA SIZE       =    587      20
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
