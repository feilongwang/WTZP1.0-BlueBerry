C51 COMPILER V9.00   CONTROL                                                               08/02/2018 18:09:58 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE CONTROL
OBJECT MODULE PLACED IN .\Output\Control.obj
COMPILER INVOKED BY: E:\Program Files\keil5\C51\BIN\C51.EXE Modules\Control.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJEC
                    -TEXTEND PRINT(.\Listing\Control.lst) TABS(2) OBJECT(.\Output\Control.obj)

line level    source

   1          /*****************************************************************
   2          **                   ´óÁ¬Àí¹¤´óÑ§ ´´ÐÂ´´ÒµÑ§Ôº
   3          **                       ÎïÁªÍøÓ¦ÓÃ¹¤·»
   4          **---------------------------------------------------------------
   5          ** ÏîÄ¿Ãû³Æ£º   WTZP1.0-BlueBerry
   6          ** ÈÕ    ÆÚ£º   2018-07-21
   7          ** ×÷    Õß£º   ÎÂÎä¾ü
   8          **---------------------------------------------------------------
   9          ** ÎÄ ¼þ Ãû£º   Control.c
  10          ** ÎÄ¼þËµÃ÷£º   ±Ã¿ØÖÆ¹¦ÄÜÄ£¿é
  11          *****************************************************************/
  12          /*---------------------INCLUDES----------------------*/
  13          #include "Control.h"
  14          
  15          /*---------------------VARIABLES---------------------*/
  16          /***********************************************************************
  17          ** ²ÎÊýËµÃ÷£º MOS¹ÜµÄ¿ª¹Ø×´Ì¬´¢´æÊý×é£¬MOSHand£¨ÈË¹¤ÏÖ³¡¿ØÖÆÓëÔÆÆ½Ì¨¿ØÖÆ£©£¬MOSAuto£¨ÏµÍ³×Ô¶¯¿ØÖÆ£©£¬0-¹Ø£
             -¬1-¿ª
  18          ***********************************************************************/
  19          uint8 MOSHand[4]={0,0,0,0},MOSAuto[4]={0,0,0,0};
  20          /***********************************************************************
  21          ** ²ÎÊýËµÃ÷£º ¿ØÖÆÏìÓ¦±êÖ¾£¬HighControlAckFlag£¨ÈË¹¤ÏÖ³¡¿ØÖÆÓëÔÆÆ½Ì¨¿ØÖÆ£©£¬ControlAckFlag£¨ÏµÍ³×Ô¶¯¿ØÖÆ£©
             -£¬ControlPrmFlag£¨²ÎÊý¸Ä±ä£©0-ÎÞ£¬1-ÓÐ
  22          ***********************************************************************/
  23          static uint8 HighControlAckFlag=0,ControlAckFlag=0,ControlPrmFlag=1;
  24          char ControlKeyName[6][15]={"ControlPh","","","","data","apitag"};
  25          uint16 PrmEC;
  26          uint16 PrmPH;
  27          
  28          /*---------------------FUNCTIONS---------------------*/
  29          /*{
  30          MOS1=0;PH
  31          MOS2=0;EC
  32          MOS3=0;
  33          MOS4=0;
  34          }*///0 off 1 on
  35          /***********************************************************************
  36          ** º¯ Êý Ãû£º MOSControl()
  37          ** º¯ÊýËµÃ÷£º MOS¹ÜµÄ¿ØÖÆº¯Êý
  38          **---------------------------------------------------------------------
  39          ** ÊäÈë²ÎÊý£º uint8 MOSNum£¨ÐèÒª´ò¿ªµÄMOSÐòºÅ£©uint8 Switch(¿ª¹Ø×´Ì¬)
  40          ** ·µ»Ø²ÎÊý£º ÎÞ£¬±ÃµÄ×´Ì¬£¬0-¹Ø£¬1-¿ª
  41          ***********************************************************************/
  42          void MOSControl(uint8 MOSNum,uint8 Switch)
  43          {
  44   1        switch(MOSNum)
  45   1        {
  46   2          case 0:MOS1=Switch;break;
  47   2          case 1:MOS2=Switch;break;
  48   2          case 2:MOS3=Switch;break;
  49   2          case 3:MOS4=Switch;break;
  50   2        }
  51   1      }
  52          /***********************************************************************
C51 COMPILER V9.00   CONTROL                                                               08/02/2018 18:09:58 PAGE 2   

  53          ** º¯ Êý Ãû£º MOSArb()
  54          ** º¯ÊýËµÃ÷£º MOS¹ÜµÄ¿ª¹ØÖÙ²Ã
  55          **---------------------------------------------------------------------
  56          ** ÊäÈë²ÎÊý£º uint8 MOSNum£¨ÐèÒªÖÙ²ÃµÄMOSÐòºÅ£©
  57          ** ·µ»Ø²ÎÊý£º uint8,±ÃµÄ×´Ì¬£¬0-¹Ø£¬1-¿ª,FF-Ã»ÓÐ±Ã²Ù×÷
  58          ***********************************************************************/
  59          uint8 MOSArb(uint8 MOSNum)
  60          {
  61   1        static uint8 HighInterruptCnt=0;
  62   1        //ÖÙ²ÃÔ­Ôò£ºÈË¹¤ÓëÔÆÆ½Ì¨Í¬Êô×î¸ß¼¶±ðÖÐ¶Ï£¨ÓÉÏÈºóÅÐ¶Ï£©£¬×Ô¶¯¿ØÖÆÊôÓÚµÍ¼¶±ðÖÐ¶Ï
  63   1        if((!HighControlAckFlag)&ControlAckFlag)//µ±ÔÆÆ½Ì¨ÓëÈË¹¤ÎÞ²Ù×÷Ê±£¬×Ô¶¯¿ØÖÆÏìÓ¦
  64   1        {
  65   2          MOSControl(MOSNum,MOSAuto[MOSNum]);//¿ØÖÆ±Ã
  66   2          ControlAckFlag=0;//Çå³ý±êÖ¾
  67   2          MOSHand[MOSNum]=MOSAuto[MOSNum];//Í³Ò»±Ã×´Ì¬
  68   2          return MOSAuto[MOSNum];
  69   2        }
  70   1        else if(HighControlAckFlag&ControlAckFlag)//ÔÆÆ½Ì¨»òÕßÈË¹¤²Ù×÷Ê±£¬ÆÁ±Î×Ô¶¯¿ØÖÆÏìÓ¦
  71   1        {
  72   2          MOSControl(MOSNum,MOSHand[MOSNum]);//¿ØÖÆ±Ã
  73   2          ControlAckFlag=0;//Çå³ý±êÖ¾£¬¸ß¼¶ÖÐ¶Ï²Ù×÷ÔÚÏÂ´Î¸ß¼¶ÖÐ¶Ï²Ù×÷Ê±Çå³ý
  74   2          MOSAuto[MOSNum]=MOSHand[MOSNum];//Í³Ò»±Ã×´Ì¬
  75   2          HighInterruptCnt++;
  76   2          if(HighInterruptCnt==2)//Çå³ý¸ß¼¶ÖÐ¶Ï±êÖ¾
  77   2          {
  78   3            HighInterruptCnt=0;
  79   3            HighControlAckFlag=0;
  80   3          }
  81   2          return MOSHand[MOSNum];
  82   2        }
  83   1        else if(!ControlAckFlag)//ÎÞ±Ã²Ù×÷Ê±ÏìÓ¦
  84   1        {
  85   2          return 0XFF;
  86   2        }
  87   1        return 0XFF;
  88   1      }
  89          /***********************************************************************
  90          ** º¯ Êý Ãû£º MOSMesRec()
  91          ** º¯ÊýËµÃ÷£º MOS¹Ü¿ØÖÆÊý¾Ý²É¼¯(¶ÔÈË¹¤²Ù×÷ºÍÔÆÆ½Ì¨)
  92          **---------------------------------------------------------------------
  93          ** ÊäÈë²ÎÊý£º ÎÞ
  94          ** ·µ»Ø²ÎÊý£º ÎÞ
  95          ***********************************************************************/
  96          void MOSMesRec()
  97          {
  98   1        char *NetData;
  99   1        char *NetKey;
 100   1        char Ackcmp[4],i;
 101   1        if(Urst3Rec)//ÈË¹¤ÏÖ³¡¿ØÖÆ
 102   1        {
 103   2          switch(Urst3Rec)
 104   2          {
 105   3            case 0x10:MOSHand[0]=0;break;
 106   3            case 0x11:MOSHand[0]=1;break;
 107   3            case 0x20:MOSHand[1]=0;break;
 108   3            case 0x21:MOSHand[1]=1;break;
 109   3            case 0x30:MOSHand[2]=0;break;
 110   3            case 0x31:MOSHand[2]=1;break;
 111   3            case 0x40:MOSHand[3]=0;break;
 112   3            case 0x41:MOSHand[3]=1;break;
 113   3          }
 114   2          Urst3Rec=0;
C51 COMPILER V9.00   CONTROL                                                               08/02/2018 18:09:58 PAGE 3   

 115   2          HighControlAckFlag=1;
 116   2          ControlAckFlag=1;
 117   2        }
 118   1        if(Urst2Rec)
 119   1        {
 120   2          (int)NetKey=JsonKeyRec(ControlKeyName[5]);
 121   2          Ackcmp[0]=!strcmp(NetKey,ControlKeyName[0]);
 122   2          Ackcmp[1]=!strcmp(NetKey,ControlKeyName[1]);
 123   2          Ackcmp[2]=!strcmp(NetKey,ControlKeyName[2]);
 124   2          Ackcmp[3]=!strcmp(NetKey,ControlKeyName[3]);
 125   2          for(i=0;i<4;i++)
 126   2          {
 127   3            if(Ackcmp[i])
 128   3            {
 129   4              (int)NetData=JsonKeyRec(ControlKeyName[4]);
 130   4              MOSHand[i]=*NetData;
 131   4              HighControlAckFlag=1;
 132   4              ControlAckFlag=1;
 133   4            }
 134   3          }
 135   2          Urst2Rec=0;
 136   2        }
 137   1      }
 138          /***********************************************************************
 139          ** º¯ Êý Ãû£º ControlPrm()
 140          ** º¯ÊýËµÃ÷£º Ö²ÎïÉú³¤¿ØÖÆ²ÎÊýµ÷Õû
 141          **---------------------------------------------------------------------
 142          ** ÊäÈë²ÎÊý£º ÎÞ
 143          ** ·µ»Ø²ÎÊý£º ÎÞ
 144          ***********************************************************************/
 145          void ControlPrm()
 146          {
 147   1        PrmEC=IapRead(0x0102);
 148   1        PrmEC=PrmEC<<8;
 149   1        PrmEC=PrmEC|IapRead(0x0101);//»ñÈ¡EC²ÎÊýÖµ
 150   1        PrmPH=IapRead(0x0100);//»ñÈ¡PH²ÎÊý
 151   1      }
 152          /***********************************************************************
 153          ** º¯ Êý Ãû£º AutoControl()
 154          ** º¯ÊýËµÃ÷£º ÏµÍ³×Ô¶¯¿ØÖÆ±Ãº¯Êý
 155          **---------------------------------------------------------------------
 156          ** ÊäÈë²ÎÊý£º ÎÞ
 157          ** ·µ»Ø²ÎÊý£º ÎÞ
 158          ***********************************************************************/
 159          void AutoControl()
 160          {
 161   1        static char AlamCnt[2]={0,0};//0-PH 1-EC
 162   1        if(DatePh>PrmPH)
 163   1        {
 164   2          AlamCnt[0]++;
 165   2          if(AlamCnt[0]>4)
 166   2          {
 167   3            AlamCnt[0]=0;
 168   3            MOSAuto[0]=1;
 169   3            ControlAckFlag=1;
 170   3          }
 171   2        }
 172   1        if(DateEc<PrmEC)
 173   1        {
 174   2          AlamCnt[1]++;
 175   2          if(AlamCnt[1]>4)
 176   2          {
C51 COMPILER V9.00   CONTROL                                                               08/02/2018 18:09:58 PAGE 4   

 177   3            AlamCnt[1]=0;
 178   3            MOSAuto[1]=1;
 179   3            ControlAckFlag=1;
 180   3          }
 181   2        }
 182   1      }
 183          /***********************************************************************
 184          ** º¯ Êý Ãû£º AsmControl()
 185          ** º¯ÊýËµÃ÷£º ¿ØÖÆÏµÍ³×Üº¯Êý
 186          **---------------------------------------------------------------------
 187          ** ÊäÈë²ÎÊý£º ÎÞ
 188          ** ·µ»Ø²ÎÊý£º ÎÞ
 189          ***********************************************************************/
 190          void AsmControl()
 191          {
 192   1        if(ControlPrmFlag)//²é¿´Ö²ÎïÉú³¤²ÎÊýÊÇ·ñ¸Ä±ä
 193   1        {
 194   2          ControlPrm();
 195   2          ControlPrmFlag=0;
 196   2        }
 197   1        AutoControl();//×Ô¶¯¿ØÖÆÖ¸Áî
 198   1        MOSMesRec();//ÆäËû¿ØÖÆÖ¸Áî
 199   1        MOSArb(0);MOSArb(1);MOSArb(2);MOSArb(3);//MOS¹Ü¿ØÖÆÖÙ²Ã
 200   1      }
 201          
 202          
 203          
 204          
 205          
 206          
 207          
 208          
 209          
 210          
 211          
 212          
 213          
 214          
 215          
 216          
 217          
 218          
 219          
 220          
 221          
 222          
 223          
 224          
 225          
 226          
 227          
 228          
 229          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    790    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    108      11
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
C51 COMPILER V9.00   CONTROL                                                               08/02/2018 18:09:58 PAGE 5   

   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
